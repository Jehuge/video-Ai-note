# Video AI Note 技术原理详解

## 项目概述

Video AI Note 是一个智能视频笔记生成工具，能够自动提取视频音频、转写文字，并使用 AI 生成结构化的 Markdown 笔记。项目采用完全本地化处理，保护数据隐私，支持 Ollama 等本地大模型，无需联网即可使用。

## 系统架构

### 整体架构图

```mermaid
graph TB
    subgraph "前端层 (Frontend)"
        A[React + TypeScript] --> B[组件层]
        B --> C[API 服务层]
        C --> D[状态管理]
    end
    
    subgraph "后端层 (Backend)"
        E[FastAPI 服务器] --> F[路由层]
        F --> G[服务层]
        G --> H[业务逻辑]
    end
    
    subgraph "核心处理模块"
        I[音频提取模块] --> J[FFmpeg]
        K[语音转文字模块] --> L[Fast-Whisper]
        M[AI 笔记生成模块] --> N[GPT/LLM]
        O[截图生成模块] --> P[FFmpeg]
    end
    
    subgraph "数据存储"
        Q[(SQLite 数据库)]
        R[文件系统]
        S[缓存文件]
    end
    
    C -->|HTTP API| E
    H --> I
    H --> K
    H --> M
    H --> O
    I --> R
    K --> S
    M --> S
    O --> R
    H --> Q
    
    style A fill:#61dafb
    style E fill:#009688
    style J fill:#ff6b6b
    style L fill:#4ecdc4
    style N fill:#95e1d3
```

## 核心工作流程

### 完整处理流程

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端界面
    participant Backend as 后端服务
    participant FFmpeg as FFmpeg
    participant Whisper as Fast-Whisper
    participant LLM as AI 模型
    participant DB as 数据库
    participant FS as 文件系统

    User->>Frontend: 1. 上传视频文件
    Frontend->>Backend: POST /api/upload
    Backend->>FS: 保存视频文件
    Backend->>DB: 创建任务记录 (pending)
    Backend-->>Frontend: 返回 task_id
    
    User->>Frontend: 2. 执行步骤：提取音频
    Frontend->>Backend: POST /api/task/{task_id}/step/extract
    Backend->>FFmpeg: 提取音频 (16kHz, 单声道)
    FFmpeg->>FS: 保存音频文件
    Backend->>DB: 更新状态 (processing)
    Backend-->>Frontend: 返回成功
    
    User->>Frontend: 3. 执行步骤：转写文字
    Frontend->>Backend: POST /api/task/{task_id}/step/transcribe
    Backend->>FS: 检查缓存
    alt 缓存存在
        FS-->>Backend: 返回缓存结果
    else 缓存不存在
        Backend->>Whisper: 转录音频
        Whisper->>FS: 保存转录结果 (JSON)
        Backend->>DB: 更新状态 (transcribed)
    end
    Backend-->>Frontend: 返回转录文本
    
    User->>Frontend: 4. 执行步骤：生成笔记
    Frontend->>Backend: POST /api/task/{task_id}/step/summarize
    Backend->>FS: 检查缓存
    alt 缓存存在且无截图
        FS-->>Backend: 返回缓存笔记
    else 需要生成
        Backend->>LLM: 调用 AI 生成笔记
        Note over LLM: 构建 Prompt<br/>包含转录文本<br/>生成结构化 Markdown
        LLM-->>Backend: 返回 Markdown 笔记
        Backend->>FS: 保存笔记文件
    end
    
    opt 如果启用截图
        Backend->>FFmpeg: 根据时间戳生成截图
        FFmpeg->>FS: 保存截图文件
        Backend->>Backend: 替换 Markdown 中的截图标记
    end
    
    Backend->>DB: 更新状态 (completed)
    Backend-->>Frontend: 返回最终笔记
    
    User->>Frontend: 5. 下载笔记 (Markdown/PDF)
    Frontend->>Backend: GET /api/task/{task_id}/download
    Backend-->>Frontend: 返回文件
```

## 技术模块详解

### 1. 音频提取模块

音频提取使用 FFmpeg 从视频文件中提取音频流，并转换为适合语音识别处理的格式。

```mermaid
flowchart LR
    A[视频文件] --> B{检查 FFmpeg}
    B -->|系统已安装| C[使用系统 FFmpeg]
    B -->|未安装| D[自动下载 FFmpeg]
    D --> E[使用项目 FFmpeg]
    C --> F[执行提取命令]
    E --> F
    F --> G[输出音频文件]
    
    F --> H["ffmpeg -i video.mp4<br/>-acodec pcm_s16le<br/>-ac 1 -ar 16000<br/>audio.wav"]
    
    style A fill:#ff6b6b
    style G fill:#4ecdc4
    style H fill:#ffe66d
```

**技术细节：**
- **采样率**：16kHz（Whisper 模型推荐）
- **声道**：单声道（减少计算量）
- **编码格式**：PCM 16-bit（无损，适合语音识别）
- **自动管理**：使用 `imageio-ffmpeg` 自动下载和管理 FFmpeg 二进制文件

### 2. 语音转文字模块

使用 Fast-Whisper（基于 CTranslate2 的 Whisper 实现）进行语音识别，相比原始 Whisper 速度提升 4-5 倍。

```mermaid
graph TD
    A[音频文件] --> B[Fast-Whisper 模型]
    B --> C{模型加载}
    C -->|首次使用| D[下载模型]
    C -->|已存在| E[加载模型]
    D --> E
    E --> F[执行转录]
    F --> G[语音活动检测 VAD]
    G --> H[自动语言检测]
    H --> I[生成分段结果]
    I --> J[保存 JSON 缓存]
    J --> K[返回转录结果]
    
    K --> L["TranscriptResult:<br/>- language: 检测语言<br/>- full_text: 完整文本<br/>- segments: 时间分段"]
    
    style B fill:#4ecdc4
    style G fill:#95e1d3
    style L fill:#ffe66d
```

**技术细节：**
- **模型选择**：支持 tiny/base/small/medium/large（默认 base）
- **VAD 过滤**：启用语音活动检测，过滤静音段
- **语言检测**：自动检测音频语言
- **分段输出**：保留时间戳信息，便于后续处理
- **缓存机制**：转录结果保存为 JSON，避免重复处理

### 3. AI 笔记生成模块

使用大语言模型（LLM）将转录文本转换为结构化的 Markdown 笔记。

```mermaid
graph TB
    A[转录文本] --> B[构建 Prompt]
    B --> C[Prompt 模板]
    C --> D{模型类型}
    
    D -->|Ollama| E[本地模型<br/>http://localhost:11434/v1]
    D -->|OpenAI| F[OpenAI API<br/>api.openai.com]
    D -->|DeepSeek| G[DeepSeek API]
    D -->|Qwen| H[Qwen API]
    
    E --> I[调用 LLM]
    F --> I
    G --> I
    H --> I
    
    I --> J[生成 Markdown]
    J --> K[后处理]
    K --> L[清理思考标签]
    L --> M[格式化输出]
    M --> N[保存缓存]
    
    style E fill:#95e1d3
    style I fill:#4ecdc4
    style J fill:#ffe66d
```

**Prompt 构建策略：**

```mermaid
graph LR
    A[转录分段] --> B[格式化分段文本]
    B --> C[添加指令]
    C --> D[语言要求]
    C --> E[格式要求]
    C --> F[内容要求]
    C --> G[截图标记要求]
    
    D --> H[最终 Prompt]
    E --> H
    F --> H
    G --> H
    
    H --> I["1. 完整信息<br/>2. 去除无关内容<br/>3. 保留关键细节<br/>4. 可读布局<br/>5. 数学公式 LaTeX<br/>6. 截图标记 *Screenshot-[mm:ss]"]
    
    style H fill:#4ecdc4
    style I fill:#ffe66d
```

**支持的模型提供商：**
- **Ollama**：本地运行，完全离线，无需 API 密钥
- **OpenAI**：GPT-3.5/GPT-4 系列
- **DeepSeek**：国产大模型
- **Qwen**：阿里通义千问
- **其他 OpenAI 兼容 API**：通过 base_url 配置

### 4. 截图生成模块

根据 Markdown 中的截图标记，从视频中提取对应时间点的帧。

```mermaid
flowchart TD
    A[Markdown 笔记] --> B[解析截图标记]
    B --> C["*Screenshot-[mm:ss]"]
    C --> D[提取时间戳]
    D --> E[转换为秒数]
    E --> F[FFmpeg 提取帧]
    F --> G[保存截图文件]
    G --> H[生成图片 URL]
    H --> I[替换 Markdown 标记]
    I --> J[更新笔记文件]
    
    F --> K["ffmpeg -ss {timestamp}<br/>-i video.mp4<br/>-vframes 1<br/>screenshot.jpg"]
    
    style C fill:#ff6b6b
    style F fill:#4ecdc4
    style I fill:#95e1d3
```

**截图标记格式：**
- 标记格式：`*Screenshot-[mm:ss]`（例如：`*Screenshot-[01:23]`）
- 插入位置：章节内容之后，空行分隔
- 自动替换：生成截图后，标记被替换为 `![](/api/note_results/screenshots/xxx.jpg)`

## 数据流与状态管理

### 任务状态流转

```mermaid
stateDiagram-v2
    [*] --> pending: 上传文件
    pending --> processing: 提取音频
    processing --> transcribing: 开始转写
    transcribing --> transcribed: 转写完成
    transcribed --> summarizing: 生成笔记
    summarizing --> completed: 笔记完成
    completed --> [*]
    
    processing --> failed: 错误
    transcribing --> failed: 错误
    summarizing --> failed: 错误
    failed --> [*]
```

### 数据存储结构

```mermaid
erDiagram
    VIDEO_TASK ||--o{ TASK_STATUS : has
    VIDEO_TASK ||--o{ CACHE_FILE : generates
    
    VIDEO_TASK {
        string task_id PK
        string filename
        string status
        bool screenshot
        datetime created_at
    }
    
    TASK_STATUS {
        string task_id FK
        string status
        string message
        datetime updated_at
    }
    
    CACHE_FILE {
        string task_id FK
        string type
        string path
    }
    
    CACHE_FILE ||--|| AUDIO_FILE : "task_id_audio.wav"
    CACHE_FILE ||--|| TRANSCRIPT_FILE : "task_id_transcript.json"
    CACHE_FILE ||--|| MARKDOWN_FILE : "task_id_markdown.md"
```

## 前端架构

### 组件层次结构

```mermaid
graph TD
    A[App.tsx] --> B[路由管理]
    B --> C[上传页面]
    B --> D[任务列表]
    B --> E[模型配置]
    
    C --> F[UploadForm 组件]
    F --> G[文件选择]
    F --> H[上传进度]
    
    D --> I[TaskList 组件]
    I --> J[TaskItem 组件]
    J --> K[TaskSteps 组件]
    K --> L[步骤执行按钮]
    K --> M[状态显示]
    
    J --> N[TaskDetailPanel]
    N --> O[视频预览]
    N --> P[转录文本查看]
    N --> Q[笔记预览]
    N --> R[下载按钮]
    
    E --> S[ModelConfig 组件]
    S --> T[模型选择]
    S --> U[API 配置]
    
    style A fill:#61dafb
    style F fill:#4ecdc4
    style I fill:#95e1d3
    style S fill:#ffe66d
```

### 状态管理

```mermaid
graph LR
    A[Zustand Store] --> B[Task Store]
    B --> C[任务列表]
    B --> D[当前任务]
    B --> E[任务状态]
    
    A --> F[Model Store]
    F --> G[模型配置]
    F --> H[当前模型]
    
    C --> I[添加任务]
    C --> J[更新任务]
    C --> K[删除任务]
    
    style A fill:#61dafb
    style B fill:#4ecdc4
    style F fill:#95e1d3
```

## 关键技术特性

### 1. 完全本地化处理

```mermaid
graph TB
    A[用户数据] --> B{处理方式}
    B -->|本地模式| C[Ollama 本地模型]
    B -->|云端模式| D[云端 API]
    
    C --> E[数据不上传]
    C --> F[完全离线]
    C --> G[隐私保护]
    
    D --> H[需要网络]
    D --> I[需要 API Key]
    
    style C fill:#95e1d3
    style E fill:#4ecdc4
    style F fill:#4ecdc4
    style G fill:#4ecdc4
```

### 2. 缓存机制

```mermaid
flowchart TD
    A[处理请求] --> B{检查缓存}
    B -->|存在| C[返回缓存]
    B -->|不存在| D[执行处理]
    D --> E[保存缓存]
    E --> F[返回结果]
    
    G[音频提取] --> H[task_id_audio.wav]
    I[转录结果] --> J[task_id_transcript.json]
    K[笔记生成] --> L[task_id_markdown.md]
    
    style B fill:#ffe66d
    style C fill:#95e1d3
    style E fill:#4ecdc4
```

**缓存策略：**
- **音频文件**：提取后保存，避免重复提取
- **转录结果**：JSON 格式，包含完整分段信息
- **笔记内容**：Markdown 格式，支持增量更新（截图功能）

### 3. 分步执行设计

系统采用分步执行设计，用户可以控制每个步骤的执行时机：

```mermaid
graph LR
    A[上传文件] --> B[步骤 1: 提取音频]
    B --> C[步骤 2: 转写文字]
    C --> D[步骤 3: 生成笔记]
    
    B --> E[可查看音频]
    C --> F[可查看转录]
    D --> G[可查看笔记]
    
    style A fill:#ff6b6b
    style B fill:#4ecdc4
    style C fill:#95e1d3
    style D fill:#ffe66d
```

**优势：**
- 用户可以随时查看中间结果
- 支持单独重试某个步骤
- 降低单次处理失败的影响范围
- 提供更好的用户体验

## 性能优化

### 1. 模型加载优化

```mermaid
graph TD
    A[首次使用] --> B[延迟加载]
    B --> C[按需初始化]
    C --> D[单例模式]
    D --> E[复用模型实例]
    
    style B fill:#95e1d3
    style D fill:#4ecdc4
```

### 2. 异步处理

```mermaid
sequenceDiagram
    participant F as 前端
    participant B as 后端
    participant W as Worker
    
    F->>B: 提交任务
    B->>B: 创建任务记录
    B-->>F: 返回 task_id
    B->>W: 后台处理
    F->>B: 轮询状态
    B-->>F: 返回当前状态
    W->>B: 更新状态
    F->>B: 获取结果
    B-->>F: 返回最终结果
```

## 安全与隐私

### 数据隐私保护

```mermaid
graph TB
    A[用户上传视频] --> B[本地存储]
    B --> C[本地处理]
    C --> D{使用本地模型?}
    D -->|是| E[完全离线]
    D -->|否| F[仅发送文本到 API]
    
    E --> G[数据不上传]
    F --> H[仅转录文本]
    H --> I[不包含视频内容]
    
    style E fill:#95e1d3
    style G fill:#4ecdc4
    style H fill:#ffe66d
```

**隐私保护措施：**
1. 所有文件存储在本地文件系统
2. 支持完全离线运行（Ollama 模式）
3. 云端 API 仅传输文本，不传输视频/音频
4. 无数据收集和追踪

## 部署架构

### 开发环境

```mermaid
graph LR
    A[前端 Dev Server<br/>:5173] --> B[Vite Proxy]
    B --> C[后端 API<br/>:8483]
    C --> D[SQLite DB]
    C --> E[文件系统]
    
    style A fill:#61dafb
    style C fill:#009688
```

### 生产环境

```mermaid
graph TB
    A[用户] --> B[Nginx]
    B --> C[前端静态文件]
    B --> D[后端 API]
    D --> E[SQLite DB]
    D --> F[文件系统]
    D --> G[FFmpeg]
    D --> H[Whisper Model]
    D --> I[Ollama/LLM]
    
    style B fill:#009688
    style D fill:#4ecdc4
```

## 总结

Video AI Note 通过以下技术实现智能视频笔记生成：

1. **音频处理**：FFmpeg 提取和转换音频
2. **语音识别**：Fast-Whisper 实现快速准确的转录
3. **AI 生成**：大语言模型生成结构化笔记
4. **截图功能**：基于时间戳的智能截图插入
5. **本地化支持**：Ollama 实现完全离线运行
6. **缓存机制**：避免重复处理，提升性能
7. **分步执行**：提供灵活的用户控制

整个系统设计注重**隐私保护**、**用户体验**和**性能优化**，是一个功能完整、技术先进的视频笔记生成工具。

